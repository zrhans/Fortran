#!/bin/bash
geragpl()
{
echo "\\n gerando gráficos... \\n"
cat<<eogpl>MEDIO.GPL

set encoding iso_8859_1
set term postscript enhanced "arial" 12
set logscale
set style line 4
set pointsize 0.5
set output '$tip-B$BANDAS-$classe-$anomes.eps'
set ylabel "nS_{uvw}/u@^{2}_* {/Symbol f}^{2/3}"
set xlabel "f=nz/U"
set title 'Espectros medios 15 dias. $classe $anomes - STM/km77 | BANDAS: $BANDAS | Trat: $tip'
p 'M$tip-$classe-$anomes.spc' u 1:2 w lp ti 'S_u' 4,'' u 1:3 w lp ti 'S_v' 3,'' u 1:4 w lp ti 'S_w' 2

eogpl
gnuplot 'MEDIO.GPL'
convert $tip-B$BANDAS-$classe-$anomes.eps $tip-B$BANDAS-$classe-$anomes.pdf
#gv $tip-B$BANDAS-$classe-$anomes.pdf &
return
}





if [ $# -ne 2 ]; then

 echo "";echo "Usage: $0 filename bandsize";echo ""
 echo " $USER! Digite o nome do arquivo com a classe e o numero de bandas para suavizar."
 echo " Exemplo: $0 SCC1-2002-03.spc 20";echo ""
 else
clear
rm -f tmpspc.dat
rm -f filetmp.dat
rm -f tmpcoco
BANDAS=$2
classe=`echo $1 | cut -c7-10`
anomes=`echo $1 | cut -c12-18`
tip=`echo $1 | cut -c1-5`
fourcol='tmpspc.dat'
tmpfour='filetmp.dat'
L=`wc -l $1 | awk '{print $1}'`

fim=$L;bot=0;top=44;

echo " \\n executando o awk... \\n "
awk '{print $33,$34,$35,$36}' $1 >$tmpfour
echo " \\n ..........OK \\ n"
echo " \\n ORDENANDO...  `date` \\n "
sort +0 -n $tmpfour > tmpcoco
mv tmpcoco $fourcol
#awk '{print $1,$2,$3,$4}' $tmpfour | sort +0 -n >$fourcol
echo " \\n Ordenando...`date` \\n "
resul=`grep -c '*' $fourcol`
echo " \\n Resultado da analise de lixo (*): $resul \\n "





cat<<eof1>>COCO
        PARAMETER(L=$L,B=$BANDAS)
	REAL DATA(L,4)
	REAL freqad(L),suad(L),svad(L),swad(L)
	REAL HZMEAN(B),SPECUMEAN(B),SPECVMEAN(B),SPECWMEAN(B)

! arquivo de entrada de dados
        OPEN(UNIT=10,FILE='$fourcol')
!arquivo de saida dos espectros medios
        OPEN(UNIT=15,FILE='M$1')
 	
	DO 10 I=1,L
      	READ (10,*,END=10)(DATA(I,J),J=1,4)
10    	CONTINUE 

eof1
awk 'NR>21{print $0}' bandas-espectro_medio.f>>COCO
data=`date`
cat<<eofcoco>>COCO

!=====================================================================
! source generated by Microm2006 - HANS/LUMET
! $data
!=====================================================================

eofcoco
echo " \\n compilando ... \\n "
mv COCO COCO.f
 rm spcmedio.x77
 g77 -o spcmedio.x77 COCO.f
 chmod +x spcmedio.x77
 echo " \\n compilado executando... \\n "
 ./spcmedio.x77
 geragpl

#gv M$BANDAS-$classe-$anomes.pdf &
fi